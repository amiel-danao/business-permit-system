{% extends 'base.html' %}
{% load static %}

{% load crispy_forms_tags %}
{% load render_table from django_tables2 %}
{% load bootstrap4 %}

{% block mycss %}
{{ block.super }}
{% bootstrap_css %}
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<link href="{% static 'css/home.css' %}" rel="stylesheet">
<style>
    /* .form-select{
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        text-indent: 1px !important;
        text-overflow: '' !important;
    } */

    .business-form-section{
        font-size:0.8rem;
    }

    .column-label{
        font-size: 0.68rem;
    }

    .form-check-inline{
        margin-right: 0px !important;
    }

    small{
        font-size: 0.68rem !important;
    }

    #div_id_barangay_business_clearance, #div_id_proof_of_business_name_registration, #div_id_community_tax_certificate{
        margin-bottom: 0px !important;
    }

    #page1Div label, #page2Div label, #page2Div .input-group-text, #table_verification_documents td{
        text-transform: uppercase;
        font-size: 0.6rem !important;
        color:black;
    }

    small, label, span, p, h1{
        letter-spacing: 0.04px;
    }

    .form-control{
        padding-top:0.9rem !important;
        padding-bottom:0px !important;
        /* height: 30px !important; */
        /* height:calc(100% - 18px) !important; */
        height: calc(2.2rem + 2px) !important;
        font-size: 12.8px !important;/*0.8rem;*/
        line-height: 1 !important;
        /* letter-spacing: 0.01px; */
     }

     td .form-control{
        padding-top:0.1rem !important;
     }

     .form-control-plaintext, .col-form-label, .activities-label p{
        font-size: 0.8rem !important;
        padding-top:0px !important;
        padding-bottom:4px !important;
        margin-bottom: 0px !important;
     }

    #page2Div .input-group-text, .activities-label, #page2Div input{
        font-size: 0.8rem !important;
        height: calc(1.8rem + 2px) !important;
        line-height: 1.25 !important;
        padding-bottom: 0px !important;
    }

    /* .form-floating label{
        transform: scale(.85) translateY(-15px) translateX(.15rem) !important;
    } */

     
</style>
{% endblock mycss %}

{% block content %}
{% include 'partials/_navbar.html' %}
<div class="container-fluid pt-5">
    <div class="d-flex align-items-start" >
        <button id="sideBarExpand" class="collapse multi-collapse btn btn-primary text-white fw-bold" data-bs-toggle="collapse" data-bs-target=".multi-collapse" aria-expanded="false" aria-controls="sideBarExpand v-pills-tab"><i class="bi bi-chevron-double-right"></i></button>
        
        <div class="col-3 nav p-5 flex-column nav-pills me-3 sidebar collapse multi-collapse show" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <button class="btn text-white fw-bold" data-bs-toggle="collapse" data-bs-target=".multi-collapse"  aria-expanded="false" aria-controls="sideBarExpand v-pills-tab">Business Management <span><i class="bi bi-chevron-double-left text-white"></i></span></button>
            <a class="nav-link {% if request.path != '/permit/create/'%}{% if not request.GET.status or request.GET.status == '1'%} active{% endif %}{% endif %}" href="{% url 'system:index'%}?status=1" id="v-pills-home-tab"  type="button"  aria-selected="true">Permit Applications</a>
            <a class="nav-link {% if request.GET.status == '2'%} active{% endif %}" href="{% url 'system:index'%}?status=2" id="v-pills-profile-tab" type="button" aria-selected="false">Denied Applications</a>
            <a class="nav-link {% if request.GET.status == '5'%} active{% endif %}" href="{% url 'system:index'%}?status=5" id="v-pills-disabled-tab" type="button"  aria-selected="false">My Businesses</a>
            <a class="nav-link {% if request.path == '/permit/create/'%} active{% endif %}" href="{% url 'system:create'%}" id="v-pills-messages-tab" type="button" role="tab" aria-selected="false">New Application</a>
        </div>
        <div class="col shadow tab-content" id="v-pills-tabContent">
            

            {% if form %}
            <div class="tab-pane fade show active" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab" tabindex="0">
                <div class="container p-2">
                    {% if messages %}
                    <div class="alert alert-danger" role="alert">
                        Please correct the following fields:
                        <ul class="messages">
                            {% for message in messages %}
                            <li class="error_field_shortcut" data-target="{% if message.extra_tags %}{{ message.extra_tags }}{% endif %}">{{ message }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <form id="permitForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                    {% include 'partials/_form_page1.html' %}

                    {% include 'partials/_form_page2.html' %}
                    
                        <div class="row" id="page2Buttons">
                            <div class="col-3">
                                <button onclick="downloadPDF()" type="button" class="btn btn-primary">Print Business Permit <i class="bi bi-printer"></i></button>
                                <!-- <a href="{% url 'system:permit-download' pk=form.instance.pk %}" type="button" class="btn btn-primary">Print Business Permit <i class="bi bi-printer"></i></a> -->
                            </div>
                        </div>

                    </form>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

    <button onclick="topFunction()" id="toTopBtn" title="Go to top"><i class="bi bi-chevron-double-up"></i></button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.1/purify.min.js" integrity="sha512-uHOKtSfJWScGmyyFr2O2+efpDx2nhwHU2v7MVeptzZoiC7bdF6Ny/CmZhN2AwIK1oCFiVQQ5DA/L9FSzyPNu6Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script type="text/javascript">
        function downloadPDF2() {
            var element = document.getElementById('page1Div');
            var opt = {
                margin:       0,
                filename:     'myfile.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { dpi: 96, scale: 0.22, letterRendering: true},
                jsPDF:        { unit: 'mm', format: [215.9, 330.2], orientation: 'portrait' }
            };

            // New Promise-based usage:
            html2pdf().set(opt).from(element).save();
        }
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            $('#page2Buttons').hide();
            
            let options = {
                orientation: 'p',
                unit: 'mm',
                format: [215.9, 330.2],
                putOnlyUsedFonts:true,
                floatPrecision: 16 // or "smart", default is 16
            }

            let doc = new jsPDF(options);

            var pdfjs = document.querySelector('#permitForm');
            var page2 = document.getElementById('page2Div');
            

            // Convert HTML to PDF in JavaScript
            doc.html(pdfjs, {
                callback: function(doc) {
                    
                    // doc.addPage();

                    doc.deletePage(8);
                    doc.save("output.pdf");
                    $('#page2Buttons').show();
                },
                x: 12,
                y: 0,
                html2canvas: {
                    scale: 0.21, 
                    // foreignObjectRendering: true,
                    onclone: function(document) {
                        // document.querySelector('.form-floating label').style.transform = 'scale(.85) translateY(-2rem) translateX(.15rem) !important';
                        // .form-floating label{
                        //     transform: scale(.85) translateY(-2rem) translateX(.15rem) !important;
                        // }
                        console.log('cloned!');
                    }
                },
                margin:[2,0,4,0]
            });
        }
    </script>

    <script type="text/javascript">
        // Get the button:
        let mybutton = document.getElementById("toTopBtn");

        // When the user scrolls down 20px from the top of the document, show the button
        window.onscroll = function() {scrollFunction()};

        function scrollFunction() {
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            mybutton.style.display = "block";
        } else {
            mybutton.style.display = "none";
        }
        }

        // When the user clicks on the button, scroll to the top of the document
        function topFunction() {
        document.body.scrollTop = 0; // For Safari
        document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        }
    </script>

    
    <script type="text/javascript">
        let transaction_type = $(`option[value="${$('#id_transaction_type').val()}"]`).text();
        $('#id_transaction_type').replaceWith(`<p id="id_transaction_type">${transaction_type}</p>`);
        $('#id_transaction_type').insertAfter($('label[for="id_transaction_type"]'));
        $('#id_transaction_type').parent().removeClass('form-floating');


        $('#deed_row').addClass('mt-5');
        $('input').each(function(){
            $(this).removeAttr('placeholder');
        });

        $('.underlined-input, #fire_inspection_fee, #estimated_capitalization, .to_disable_on_read_only, .form-check-input').each(function( index ) {
            $(this).prop('readonly', true);
            if($(this).hasClass('form-control')){
                $(this).addClass('form-control-plaintext');
                $(this).removeClass('form-control');
            }

            if($(this).hasClass('input-group-text')){
                $(this).addClass('m-auto');
                $(this).addClass('mr-2');
            }
            $(this).removeClass('input-group-text');

            if($(this).hasClass('form-check-input')){
                $(this).prop('disabled', true);
            }
        });
        

        $('input[type="file"]').remove();

        
        if ($('#government_entity').length > 0){
            $('#government_entity_yes').prop('checked', true);
        }
        else{
            $('#government_entity_no').prop('checked', true);
        }

    </script>
{% endblock %}


